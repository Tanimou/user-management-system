---
applyTo: '**'
---

<todos title="Fix User-Detail Tests and Verify API Test Suite" agentRequirement="Review steps frequently throughout the conversation and DO NOT stop between steps unless they explicitly require it. Keep the todos updated using the todo_write tool (do not edit this file).">
- [x] fix-user-detail-syntax-errors: Fix all syntax errors in api/tests/user-detail.test.ts and api/users/[id].ts handler file ðŸ”´
  _Fixed syntax error in /api/users/[id].ts (missing comma in withCORS call). Syntax was preventing tests from running._
- [x] fix-authentication-mocks: Resolve authentication and middleware mocking issues in user-detail tests ðŸ”´
  _Updated middleware mocks to include comprehensive coverage (withAuth, withSelfOrAdmin, withAdminRole, preventSelfDemotion, validateBody, validateQuery). Fixed user context structure to include both 'id' and 'userId' properties to match enhanced auth middleware interface._
- [x] fix-permission-check-tests: Fix failing permission check tests for 404 responses and admin role requirements ðŸŸ¡
  _Root cause: withSelfOrAdmin middleware was checking permissions before database existence checks. Fixed by ensuring test users have proper admin roles when testing 404 scenarios for non-existent users. Updated test users to have ['admin', 'user'] roles where admin functionality is being tested._
- [x] verify-all-tests-pass: Run complete API test suite to verify all 199 tests pass including user-detail.test.ts ðŸ”´
  _SUCCESS: All 199 tests pass across 15 test files. User-detail.test.ts now has all 22 tests passing. Fixed user context mismatch between handler (uses req.user.id) and test mocks (was using userId). The fix ensures consistent user identification throughout the authentication flow._
</todos>

<!-- Auto-generated todo section -->
<!-- Add your custom Copilot instructions below -->
